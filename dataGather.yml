---
- name : Monitor
  hosts : all
  become : true
  vars :
    OutFile : /home/aritra/monitor/Monitor_data.txt
  tasks :
    - name : Cler Output file
      delegate_to : localhost
      copy :
        content : ""
        dest : "{{OutFile}}"

    - name : Cpu Data
      shell : sar 1 3 | tail -1 | awk '{print 100-$NF}'
      register : cpu_usage
    
    - name : Memory Data
      shell : free -m | awk 'NR == 2 {print $3/$2*100}'
      register : mem_usage

    - name : Swap Data
      shell : free -m | awk 'NR == 3 {print $3/$2*100}'
      register : swap_usage

    - name : Read FS Mon File
      set_fact :
        fs_mon : "{{lookup('file','/home/aritra/monitor/fs.mon').splitlines()}}"

    - name : Disk Data
      shell : for fs in {{fs_mon | join(' ')}} ; do df -h ${fs} 2>/dev/null | tr -d "%" | awk 'NR>1{print $(NF) "-" $(NF-1)}' ; done | tr "\n" ";"
      register : disk_usage

    - name : Save Data
      delegate_to: localhost
      lineinfile :
        path : "{{OutFile}}"
        line : "{{inventory_hostname}},{{cpu_usage.stdout}},{{mem_usage.stdout}},{{swap_usage.stdout}},{{disk_usage.stdout}}"
...